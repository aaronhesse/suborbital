/*! webrtc-beta-pubnub - v0.5.0 - 2013-07-12
* Copyright (c) 2013 ; Licensed  */
!function(a,b){function c(){console.error.apply(console,arguments)}function d(){n===!0&&console.log.apply(console,arguments)}function e(a,b,c){return c?(a.setAttribute(b,c),void 0):a&&a.getAttribute&&a.getAttribute(b)}function f(a,b){for(var c in b)a[c]=b[c];return a}function g(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"===a?b:8|3&b;return c.toString(16)});return a}function h(a){var b=a.split("b=AS:30");if(1===b.length)return a;var c=b[0]+"b=AS:1638400"+b[1];return c}function i(a,b){function e(a,b,c){var d=[];this.peerReady=!1,this.selfUuid=b,this.otherUuid=c,this.send=function(e,f){var g=e;e.uuid=b,e=JSON.stringify(e),this.peerReady===!0||f===!0?(e.sdp,a.publish({channel:o+c,message:e})):d.push(g)},this.initiate=function(){this.send({initiation:!0},!0)},this.peerIsReady=function(){this.peerReady=!0,d.unshift({negotiationReady:!0}),d.forEach(function(a){this.send(a)}.bind(this)),d=[]}}function g(b){if(b=JSON.parse(b),null!=b.uuid){if(b.uuid===s)return;d("Got message",b);var e=null!=p[b.uuid];e===!1&&a.createP2PConnection(b.uuid,!1);var f=p[b.uuid];f.signalingChannel.peerReady||f.signalingChannel.peerIsReady(),null!=b.sdp?f.connection.setRemoteDescription(new l(b.sdp),function(){for(var d=0;d<f.candidates;d++)f.connection.addIceCandidate(new k(f.candidates[d])),f.candidates=[];"have-remote-offer"===f.connection.signalingState&&f.connection.createAnswer(function(b){a.gotDescription(b,f)},function(a){delete p[b.uuid],c("Error creating answer: ",a)})},function(a){c("Error setting remote description: ",a)}):b.initiation===!0?a.createP2PConnection(b.uuid,!0):null!=f.connection.remoteDescription&&"connected"!==f.connection.iceConnectionState?f.connection.addIceCandidate(new k(b.candidate)):f.candidates.push(b.candidate)}}function i(a,b){b.type===w.STREAM?a.connection.addStream(b.stream):b.type===w.MESSAGE?("object"==typeof b.message&&(b.message=JSON.stringify(b.message)),a.dataChannel.send(b.message)):c("Unrecognized RTC message type: "+b.type)}var n={},o="pn_",p={},q={iceServers:[{url:m?"stun:stun.l.google.com:19302":"stun:23.21.150.121"}]},r=m?{optional:[{RtpDataChannels:!0}]}:{},s=b,t={},u=!1,v=[],w={STREAM:1,MESSAGE:2};return a.UUID=b,a.subscribe({channel:o+b,restore:!1,connect:function(){u=!0;for(var b=0;b<v.length;b++){var c=v[b];c.length>1?(c[1].signalingChannel.initiate(),a.gotDescription.apply(a,c)):1===c.length&&c[0].signalingChannel.initiate()}v=[]},callback:g}),n.gotDescription=function(a,b){m&&(a.sdp=h(a.sdp)),b.connection.setLocalDescription(a),u===!1?v.push([a,b]):b.signalingChannel.send({sdp:a})},n.createP2PConnection=function(a,b){if(null==p[a]){var f=new j(q,r),g=new e(this,s,a),h=this,i=function(b){p[a].dataChannel=b.channel,p[a].dataChannel.onmessage=function(b){var c=b.data;try{c=JSON.parse(b.data)}catch(d){}p[a].callback?p[a].callback(c,b):p[a].history.push(c)},p[a].connection.onaddstream=function(b){p[a].stream?p[a].stream(b.data,b):p[a].history.push(b.data)},p[a].dataChannel.onopen=function(){p[a].connected=!0,h._peerPublish(a)}};if(f.ondatachannel=i,f.onicecandidate=function(a){null!=a.candidate&&g.send({candidate:a.candidate})},f.oniceconnectionstatechange=function(){"connected"===f.iceConnectionState},t[a]=[],p[a]={connection:f,candidates:[],connected:!1,createdOffer:b!==!1,history:[],signalingChannel:g},s>a){var k=f.createDataChannel("pubnub",m?{reliable:!1}:{});i({channel:k}),f.createOffer(function(b){h.gotDescription(b,p[a])},function(b){delete p[a],c(b)})}else u===!1?v.push([p[a]]):g.initiate()}else d("Trying to connect to already connected user: "+a)},n._peerPublish=function(a){t[a]&&t[a].length>0&&p[a].connected===!0&&(i(p[a],t[a].shift()),this._peerPublish(a))},n.publish=function(b){return function(d){null==d&&c("You must send an object when using PUBNUB.publish!"),null!=d.user?(null==p[d.user]&&a.createP2PConnection(d.user),null!=d.stream?t[d.user].push({type:w.STREAM,stream:d.stream}):null!=d.message?t[d.user].push({type:w.MESSAGE,message:d.message}):c("Stream or message key not found in argument object. One or the other must be provided for RTC publish calls!"),this._peerPublish(d.user)):b.apply(this,arguments)}}(a.publish),n.subscribe=function(b){return function(e){if(null==e&&c("You must send an object when using PUBNUB.subscribe!"),null==e.user)return b.apply(this,arguments);null==p[e.user]&&a.createP2PConnection(e.user);var f=p[e.user];if(e.stream&&(f.stream=e.stream),e.callback&&(f.callback=e.callback),d("Subscribing!",f.history),f.history.length>0)for(var g=0;g<f.history.length;g++){var h=f.history[g];e.callback&&e.callback(h)}}}(a.subscribe),n.unsubscribe=function(a){return function(b){if(null==b&&c("You must send an object when using PUBNUB.unsubscribe!"),null==b.user)return a.apply(this,arguments);var d=p[b.user];null!=d&&(null!=d.dataChannel&&d.dataChannel.close(),d.connection.close(),p[b.user]=null)}}(a.unsubscribe),n.history=function(a){return function(b){if(null==b&&c("You must send an object when using PUBNUB.history!"),null==b.user)return a.apply(this,arguments);if(b.callback){var d=p[b.user].history||[[]];b.callback([d])}else c("No callback provided for PUBNUB.history")}}(a.history),n.peerConnection=function(a,b){b?null!=p[a]?b(p[a].connection):b(null):d("PUBNUB.peerConnection should be called with a callback")},n.dataChannel=function(a,b){b?null!=p[a]?b(p[a].dataChannel):b(null):d("PUBNUB.dataChannel should be called with a callback")},n.configurePeerConnection=function(a,b){null!=a&&(q=a),null!=b&&(r=b)},f(a,n)}var j,k,l,m=!!a.webkitRTCPeerConnection;m?(j=webkitRTCPeerConnection,k=a.RTCIceCandidate,l=a.RTCSessionDescription):(j=mozRTCPeerConnection,k=mozRTCIceCandidate,l=mozRTCSessionDescription);var n=!0;b.init=function(a){return function(b){var c=b.uuid||g();b.uuid=c,d(b);var e=a.call(this,b);return e=i(e,c)}}(b.init);var o=document.querySelector("#pubnub");o&&(a.PUBNUB=b.init({notest:1,publish_key:e(o,"pub-key"),subscribe_key:e(o,"sub-key"),ssl:!document.location.href.indexOf("https")||"on"===e(o,"ssl"),origin:e(o,"origin"),uuid:e(o,"uuid")}))}(window,PUBNUB);